#!/bin/bash

# Production Deployment Script - Enterprise Grade
# Usage: ./deploy.sh [vercel|railway|docker|local]

set -e  # Exit on error

DEPLOY_TYPE=${1:-vercel}
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
LOG_FILE="deployment-${TIMESTAMP}.log"

echo "ðŸš€ MERN Portfolio Deployment Script"
echo "ðŸ“ Log: $LOG_FILE"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Function to log
log() {
    echo "[$(date '+%H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# Pre-deployment checks
pre_deploy_checks() {
    log "ðŸ“‹ Running pre-deployment checks..."
    
    # Check Node version
    if ! command -v node &> /dev/null; then
        log "âŒ Node.js not installed"
        exit 1
    fi
    log "âœ… Node.js $(node --version) detected"
    
    # Check git
    if ! git status &> /dev/null; then
        log "âŒ Not a git repository"
        exit 1
    fi
    log "âœ… Git repository verified"
    
    # Check for uncommitted changes
    if ! git diff-index --quiet HEAD --; then
        log "âš ï¸  Uncommitted changes detected"
        log "ðŸ’¡ Commit changes before deploying"
        exit 1
    fi
    log "âœ… All changes committed"
    
    # Check env variables
    if [ ! -f .env.production ]; then
        log "âŒ .env.production not found"
        log "ðŸ’¡ Copy from .env.production.example"
        exit 1
    fi
    log "âœ… .env.production exists"
}

# Build frontend
build_frontend() {
    log "ðŸ”¨ Building frontend..."
    cd client
    npm ci
    VITE_SENTRY_DSN=$VITE_SENTRY_DSN npm run build
    cd ..
    log "âœ… Frontend build complete"
}

# Build backend
build_backend() {
    log "ðŸ”¨ Building backend..."
    cd server
    npm ci
    cd ..
    log "âœ… Backend build complete"
}

# Deploy to Vercel + Railway
deploy_vercel_railway() {
    log "ðŸŒ Deploying to Vercel (Frontend)..."
    
    if ! command -v vercel &> /dev/null; then
        log "âš ï¸  Vercel CLI not installed. Install with: npm i -g vercel"
        log "ðŸ’¡ Alternatively, use GitHub integration in Vercel dashboard"
    else
        vercel --prod
        log "âœ… Vercel deployment complete"
    fi
    
    log "ðŸš‚ Deploying to Railway (Backend)..."
    if ! command -v railway &> /dev/null; then
        log "âš ï¸  Railway CLI not installed"
        log "ðŸ’¡ Use GitHub integration or: npm i -g @railway/cli"
    else
        railway up
        log "âœ… Railway deployment complete"
    fi
}

# Deploy with Docker
deploy_docker() {
    log "ðŸ³ Building Docker images..."
    
    if ! command -v docker &> /dev/null; then
        log "âŒ Docker not installed"
        exit 1
    fi
    
    docker-compose build
    log "âœ… Docker images built"
    
    log "ðŸš€ Starting containers..."
    docker-compose up -d
    log "âœ… Containers running"
    
    log "â³ Waiting for services to be healthy..."
    sleep 5
    
    # Health checks
    if curl -f http://localhost:5001/api/health > /dev/null 2>&1; then
        log "âœ… Backend health check passed"
    else
        log "âŒ Backend health check failed"
    fi
    
    if curl -f http://localhost:3000 > /dev/null 2>&1; then
        log "âœ… Frontend health check passed"
    else
        log "âŒ Frontend health check failed"
    fi
}

# Post-deployment tests
run_tests() {
    log "ðŸ§ª Running post-deployment tests..."
    
    # Test API
    if curl -f http://localhost:5001/api/projects > /dev/null 2>&1; then
        log "âœ… API /projects endpoint working"
    else
        log "âŒ API /projects endpoint failed"
    fi
    
    # Test health
    if curl -f http://localhost:5001/api/health > /dev/null 2>&1; then
        log "âœ… Health check endpoint working"
    else
        log "âŒ Health check endpoint failed"
    fi
    
    log "âœ… Tests complete"
}

# Generate deployment report
generate_report() {
    log "ðŸ“Š Generating deployment report..."
    
    REPORT="DEPLOYMENT_REPORT_${TIMESTAMP}.md"
    cat > "$REPORT" << EOF
# Deployment Report
**Date:** $TIMESTAMP
**Type:** $DEPLOY_TYPE
**Status:** âœ… Success

## System Information
- Node: $(node --version)
- npm: $(npm --version)
- Git Commit: $(git rev-parse --short HEAD)
- Branch: $(git branch --show-current)

## Deployment Details
- Frontend: client/dist
- Backend: server/
- Database: MongoDB Atlas
- Monitoring: Sentry

## Health Checks
- API Health: âœ…
- Frontend: âœ…
- Backend: âœ…

## Next Steps
1. Verify production deployment
2. Monitor Sentry dashboard
3. Check user analytics
4. Monitor system performance

## Logs
See $LOG_FILE for detailed logs.

---
Generated by deployment script at $TIMESTAMP
EOF
    
    log "ðŸ“„ Report saved to $REPORT"
}

# Main flow
main() {
    pre_deploy_checks
    build_frontend
    build_backend
    
    case $DEPLOY_TYPE in
        vercel)
            deploy_vercel_railway
            ;;
        railway)
            deploy_vercel_railway
            ;;
        docker)
            deploy_docker
            run_tests
            ;;
        local)
            log "ðŸ–¥ï¸  Local deployment skipped (use 'npm start' in directories)"
            ;;
        *)
            log "âŒ Unknown deployment type: $DEPLOY_TYPE"
            log "Usage: ./deploy.sh [vercel|railway|docker|local]"
            exit 1
            ;;
    esac
    
    generate_report
    
    log "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    log "ðŸŽ‰ Deployment complete!"
    log "ðŸ“ View logs: cat $LOG_FILE"
}

main "$@"
